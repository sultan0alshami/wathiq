# ğŸ“š Wathiq API & Data Access Guide

The dashboard is a Supabase-first application. Most CRUD operations happen directly from the frontend through the Supabase JavaScript client, while a compact Node/Express service handles trip syncing, PDF generation, and WhatsApp/document delivery. This guide documents both layers so you can integrate or extend safely.

---

## ğŸ”— Base URLs

| Environment | SPA / API Gateway | Supabase REST | Notes |
|-------------|-------------------|---------------|-------|
| Development | `http://localhost:8080` (Vite dev server or Render Docker dev) | `https://<project>.supabase.co/rest/v1` | Requires `.env` variables |
| Production  | `https://wathiq-7eby.onrender.com` | `https://kjtjlcvcwmlrbqdzfwca.supabase.co/rest/v1` | SPA + Express backend hosted on Render |

> All direct REST calls to Supabase must include the anon key (client) or service role key (server-only). The React app uses the anon key; the Express backend uses the service role key for privileged actions (trip sync + notifications).

---

## ğŸ” Authentication

- Supabase Auth with email/password.
- JWT is automatically attached by `@supabase/supabase-js` and honored by Row Level Security (RLS).
- For REST calls, set headers:

```http
apikey: <VITE_SUPABASE_ANON_KEY>
Authorization: Bearer <JWT returned by Supabase Auth>
Content-Type: application/json
```

Service-to-service calls (Render backend â†’ Supabase) use `SUPABASE_SERVICE_KEY` instead of the anon key.

---

## ğŸ—„ï¸ Database Tables (Supabase)

Each business module now persists directly in Supabase. Below is the mapping between UI modules and tables:

| Module | Tables | Key Columns |
|--------|--------|-------------|
| Finance | `finance_entries`, `finance_categories`, `finance_liquidity` | `user_id`, `date`, `type`, `value` |
| Sales | `sales_entries` | `meeting_date`, `meeting_time`, `customer_name`, `outcome` |
| Operations | `operations_entries`, `operations_expectations` | `task`, `owner`, `status`, `expected_next_day` |
| Marketing | `marketing_tasks`, `marketing_yesterday_tasks`, `marketing_planned_tasks` | `status`, `priority`, `assignee` |
| Customers | `customers` (legacy), `crm_customers` (new CRM view) | `status`, `source`, `estimated_value` |
| Suppliers | `suppliers`, `supplier_documents` | `status`, `estimated_value`, `file_*` metadata |
| Trips | `trip_reports`, `trip_photos` | `booking_id`, `day_date`, `checklist`, `storage_path` |
| Notifications & Roles | `notifications`, `user_roles` | `is_broadcast`, `role` |

All tables enforce `auth.uid() = user_id` (or ownership via foreign keys) through RLS. See `supabase/005_safe_business_data_tables.sql` and `supabase/006_safe_rls_policies.sql` for the authoritative schema/policy definitions.

---

## ğŸ§© Service Layer (Frontend)

The React app uses dedicated services (`src/services/*.ts`) as the only touchpoint with Supabase. Each service wraps `supabase.from(...).select/insert/update/delete` calls and enforces consistent typing:

- `FinanceService` â€“ `listByDate`, `addEntry`, `removeEntry`, `getLiquidity`, `upsertLiquidity`.
- `SalesService` â€“ `listByDate`, `addMeeting`, `removeMeeting`, `updateCustomersContacted`, `updateDailySummary`.
- `OperationsService` â€“ `listByDate`, `addOperation`, `remove`, `updateStatus`, `upsertExpectedNextDay`.
- `MarketingService` â€“ `listTasksByDate`, `moveTask`, `addYesterdayTask`, `addPlannedTask`, etc.
- `CustomersService` â€“ `list`, `add`, `remove`, `updateStatus` (CRM pipeline).
- `SupplierService` â€“ `list`, `add`, `update`, `remove`, `uploadDocument` (base64 â†’ Supabase Storage).
- `TripReportsService` â€“ `listByDate`, `create`, `update`, `remove`, `uploadDocument`.

> When adding a new API, prefer extending these service files so all Supabase logic stays centralized.

---

## ğŸŒ Custom Express Endpoints

| Endpoint | Method | Body | Purpose |
|----------|--------|------|---------|
| `/api/trips/sync` | `POST` | `{ trip: TripEntry, attachments: Array<{ base64, name, mimeType }> }` | Uploads trip data + photos, replaces previous attachments when editing, emits Supabase notification. Requires service role key on the server. |
| `/generate-pdf` | `POST` | `{ data: DailyReportPayload, date?: string }` | Streams an Arabic PDF generated by `generate_pdf.py`, uploads optional WhatsApp document, and broadcasts a Supabase notification. |
| `/health` | `GET` | â€“ | Simple health probe used by Render. |

### `/api/trips/sync` request example
```json
{
  "trip": {
    "id": "trip-2025-11-24-001",
    "bookingId": "WTH-25-11-0001",
    "date": "2025-11-24",
    "supplier": "Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ø«Ù‚",
    "clientName": "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ",
    "createdBy": "e3e619c3-99e3-4d08-8c40-06ac5bd0bbe6",
    "checklist": {
      "externalClean": "good",
      "internalClean": "good",
      "carSmell": "good",
      "driverAppearance": "good",
      "acStatus": "good",
      "engineStatus": "good"
    }
  },
  "attachments": [
    {
      "base64": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQ...",
      "name": "front-seat.jpg",
      "mimeType": "image/jpeg"
    }
  ]
}
```

### Response
```json
{
  "success": true,
  "tripId": "trip-2025-11-24-001",
  "photosUploaded": 1,
  "photos": [
    {
      "trip_id": "trip-2025-11-24-001",
      "storage_path": "trip-reports/trip-2025-11-24-001/1732527236670-a7e2....jpg",
      "file_name": "front-seat.jpg",
      "file_size": 184233,
      "mime_type": "image/jpeg"
    }
  ]
}
```

**Validation rules**
- Requires at least one attachment.
- Detects updates by `trip.id`; when updating it deletes previous photos/bucket objects.
- Emits Supabase notifications (broadcast info message).

---

## ğŸ“‘ Supabase REST Examples

Although the React app uses the JS client, you can call Supabase REST endpoints directly. Replace `${PROJECT}` with `kjtjlcvcwmlrbqdzfwca`.

### List finance entries for a day
```http
GET https://${PROJECT}.supabase.co/rest/v1/finance_entries?day_date=eq.2025-11-24&select=*
apikey: <VITE_SUPABASE_ANON_KEY>
Authorization: Bearer <JWT>
```

### Insert a sales meeting
```http
POST https://${PROJECT}.supabase.co/rest/v1/sales_entries
apikey: <VITE_SUPABASE_ANON_KEY>
Authorization: Bearer <JWT>
Prefer: return=representation
Content-Type: application/json

{
  "user_id": "<auth.uid()>",
  "customer_name": "Ø´Ø±ÙƒØ© Ø§Ù„ÙØ¬Ø±",
  "contact_name": "Ù…Ø±ÙˆØ§Ù† Ø³Ø§Ù…ÙŠ",
  "phone_number": "+966555123456",
  "meeting_date": "2025-11-24",
  "meeting_time": "13:00+03",
  "outcome": "pending",
  "notes": "ÙŠØ­ØªØ§Ø¬ Ø¹Ø±Ø¶ Ø£Ø³Ø¹Ø§Ø± Ù…Ø­Ø¯Ø«"
}
```

### Update operations expectation (UPSERT)
```http
POST https://${PROJECT}.supabase.co/rest/v1/operations_expectations
apikey: <SERVICE_ROLE_KEY>   # server-side preferred
Authorization: Bearer <SERVICE_ROLE_KEY>
Content-Type: application/json
Prefer: resolution=merge-duplicates

{
  "user_id": "<auth.uid()>",
  "expected_next_day": 37
}
```

> The service role key is required for UPSERT into singleton tables when the row might not exist yet. The frontend delegates this to `OperationsService.upsertExpectedNextDay`, which calls a serverless function / service account when necessary.

---

## ğŸ”’ Row Level Security Recap

- All tables include `ENABLE ROW LEVEL SECURITY`.
- Policies follow the pattern:

```sql
CREATE POLICY "Users can manage their own finance entries"
ON finance_entries
FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);
```

- Tables without `user_id` (e.g., `supplier_documents`) cross-check via joins to enforce ownership.
- The safe scripts (`005_safe_business_data_tables.sql`, `006_safe_rls_policies.sql`) drop/recreate policies idempotently; run them anytime you introduce new columns.

---

## ğŸš¨ Error Handling & Rate Limits

### Backend endpoints
- `/generate-pdf` and `/api/trips/sync` share a 10 requests / 15 minutes per IP limit.
- Errors are returned as `{ message: string, detail?: string }` with appropriate HTTP status codes (400 for validation, 429 for throttling, 500 for server failures).

### Supabase REST
- Standard PostgREST errors. Example:

```json
{
  "code": "PGRST301",
  "details": null,
  "hint": null,
  "message": "Row-level security policy violation"
}
```

Handle by ensuring the JWT belongs to the correct user and that `user_id` fields are set before insert/update operations.

---

## ğŸ”„ Real-time & Notifications

- `NotificationsContext` subscribes to the `notifications` channel over Supabase Realtime.
- The backend inserts broadcast records whenever a trip or PDF event occurs.

```ts
supabase
  .channel('notifications')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, payload => {
    toast(payload.new.title);
  })
  .subscribe();
```

---

## ğŸ§ª Testing Utilities

- `/health` â€“ plain JSON response used by Render + automated smoke tests.
- Frontend unit/integration tests mock Supabase via `__tests__/__mocks__/supabase.ts`.
- To seed manual test data, run the SQL snippets inside `supabase/008_trip_reports.sql` or use Supabase dashboard inserts.

---

## ğŸ†˜ Support

- Report issues via GitHub.
- For API schema questions, reference the SQL migrations under `supabase/`.
- Contact: `sultan12alshami@gmail.com`.

**Last Updated:** November 25, 2025  
**API/Schema Version:** 2025.11 (Supabase-first release)
*** End Patch
